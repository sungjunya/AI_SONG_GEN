<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Song Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden {
            display: none;
        }

        .disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen p-6 font-sans">

    <h1 class="text-4xl font-bold text-center mb-8">ğŸµ AI Song Generator</h1>

    <!-- íšŒì›ê°€ì… / ë¡œê·¸ì¸ -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Sign Up -->
        <div class="bg-white p-6 rounded shadow">
            <h2 class="text-2xl font-semibold mb-4">íšŒì›ê°€ì…</h2>
            <input id="su-email" type="email" placeholder="ì´ë©”ì¼" class="w-full p-2 border mb-2 rounded" />
            <input id="su-username" type="text" placeholder="ì‚¬ìš©ì ì´ë¦„" class="w-full p-2 border mb-2 rounded" />
            <input id="su-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-2 border mb-4 rounded" />
            <button onclick="signup()"
                class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">ê°€ì…í•˜ê¸°</button>
        </div>
        <!-- Login -->
        <div class="bg-white p-6 rounded shadow">
            <h2 class="text-2xl font-semibold mb-4">ë¡œê·¸ì¸</h2>
            <input id="li-email" type="email" placeholder="ì´ë©”ì¼" class="w-full p-2 border mb-2 rounded" />
            <input id="li-password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-2 border mb-4 rounded" />
            <button onclick="login()"
                class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">ë¡œê·¸ì¸</button>
            <p class="mt-4 text-sm">í† í°: <span id="token-display" class="font-mono break-all"></span></p>
        </div>
    </div>

    <!-- AI ê°€ì‚¬ & ë©œë¡œë”” ìƒì„± -->
    <div class="bg-white p-6 rounded shadow mb-8">
        <h2 class="text-2xl font-semibold mb-4">AI ê°€ì‚¬ & ë©œë¡œë”” ìƒì„±</h2>
        <input id="prompt" type="text" placeholder="í”„ë¡¬í”„íŠ¸ ì…ë ¥ (ì˜ˆ: ì‚¬ë‘, ì´ë³„)" class="w-full p-2 border mb-4 rounded" />
        <div class="flex gap-2 mb-4">
            <button onclick="generateLyrics()"
                class="flex-1 bg-indigo-500 text-white py-2 rounded hover:bg-indigo-600">ê°€ì‚¬ ìƒì„±</button>
            <button onclick="generateMelody()"
                class="flex-1 bg-purple-500 text-white py-2 rounded hover:bg-purple-600">ë©œë¡œë”” ìƒì„±</button>
        </div>
        <div id="ai-results" class="space-y-4">
            <div>
                <h3 class="font-semibold">ğŸ¤ ìƒì„±ëœ ê°€ì‚¬</h3>
                <pre id="lyrics" class="bg-gray-50 p-3 rounded min-h-[80px] text-gray-800">ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</pre>
            </div>
            <div>
                <h3 class="font-semibold">ğŸ¼ ìƒì„±ëœ ë©œë¡œë”” ì„¤ëª…</h3>
                <pre id="melody" class="bg-gray-50 p-3 rounded min-h-[80px] text-gray-800">ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</pre>
            </div>
        </div>
        <button id="save-btn" onclick="saveSong()"
            class="mt-4 w-full bg-teal-500 text-white py-2 rounded hover:bg-teal-600 disabled:bg-gray-400 disabled:cursor-not-allowed"
            disabled>
            ìƒì„± ê²°ê³¼ ì €ì¥
        </button>
    </div>

    <!-- ë‚´ ë…¸ë˜ ëª©ë¡ -->
    <div class="bg-white p-6 rounded shadow">
        <h2 class="text-2xl font-semibold mb-4">ë‚´ ë…¸ë˜ ëª©ë¡</h2>
        <button onclick="loadSongs()"
            class="mb-4 bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <ul id="song-list" class="space-y-2 text-gray-700"></ul>
    </div>

    <script>
        let token = '';
        let lastLyrics = '';
        let lastMelody = '';

        async function signup() {
            const email = document.getElementById('su-email').value;
            const username = document.getElementById('su-username').value;
            const password = document.getElementById('su-password').value;
            const res = await fetch('/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, username, password })
            });
            const data = await res.json();
            alert(data.message || data.error);
        }

        async function login() {
            const email = document.getElementById('li-email').value;
            const password = document.getElementById('li-password').value;
            const res = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (data.token) {
                token = data.token;
                document.getElementById('token-display').textContent = token;
                alert('ë¡œê·¸ì¸ ì„±ê³µ');
            } else {
                alert(data.error);
            }
        }

        async function generateLyrics() {
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) return alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            document.getElementById('lyrics').textContent = 'ìƒì„± ì¤‘...';
            const res = await fetch('/generate-lyrics', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });
            const data = await res.json();
            if (data.lyrics) {
                lastLyrics = data.lyrics;
                document.getElementById('lyrics').textContent = data.lyrics;
                document.getElementById('save-btn').disabled = !(lastLyrics && lastMelody && token);
            } else {
                alert(data.error);
            }
        }

        async function generateMelody() {
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) return alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            document.getElementById('melody').textContent = 'ìƒì„± ì¤‘...';
            const res = await fetch('/generate-melody', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });
            const data = await res.json();
            if (data.melody) {
                lastMelody = data.melody;
                document.getElementById('melody').textContent = data.melody;
                document.getElementById('save-btn').disabled = !(lastLyrics && lastMelody && token);
            } else {
                alert(data.error);
            }
        }

        async function saveSong() {
            if (!token) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            const prompt = document.getElementById('prompt').value.trim();
            const res = await fetch('/songs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({
                    prompt,
                    lyrics: lastLyrics,
                    audio_url: null  // ë‚˜ì¤‘ì— ì‹¤ì œ ì˜¤ë””ì˜¤ URLì´ ìˆìœ¼ë©´ ë„£ì–´ì£¼ì„¸ìš”
                })
            });
            const data = await res.json();
            alert(data.message || data.error);
        }

        async function loadSongs() {
            if (!token) return alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            const res = await fetch('/songs', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const list = document.getElementById('song-list');
            list.innerHTML = '';
            const data = await res.json();
            data.forEach(song => {
                const li = document.createElement('li');
                li.className = 'border-b py-2';
                li.innerHTML = `<strong>${new Date(song.created_at).toLocaleString()}</strong>: ${song.prompt}`;
                list.append(li);
            });
        }
    </script>
</body>

</html>